# How to setup the environment

Here you will be introduced in how the environment is set and why. You can setup the environment following this guide or [using the
script](SCRIPTS.md) to automate this task.

## Index
* [Setting up environment variables](#setting-up-environment-variables)
* [Setting up configuration file](#setting-up-configuration-file)
* [RSA certs](#rsa-certs)
* [SQL scripts](#sql-scripts)

## Setting up environment variables

The application needs some data to start and work properly. For example, an username and password for the database connection and so on.
These data is ussually stored in environment variables. That is why you need to setup the following env vars:

* `MARIADB_HOST`: MariaDB host to be used.
* `MARIADB_USER`: MariaDB user to be used.
* `MARIADB_PASS`: MariaDB user's password.
* `MARIADB_DATABASE`: MariaDB database name.
* `IANA_TIMEZONE`: Timezone of the DB.
* `PORT`: Port where the express server will be listening.
* `MARIADB_PORT`: MariaDB port. The default port for MariaDB is 3306.
* `CLOUDINARY_CLOUD_NAME`: Cloudinary user's cloud name.
* `CLOUDINARY_API_KEY`: Cloudinary user's API Key.
* `CLOUDINARY_API_SECRET`: Cloudinary user's API Secret. 

For `IANA_TIMEZONE` env var, you can see [this article](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones). As exmaple, for Cancun city, you would use the `America/Cancun` value.

In some endpoints we are be using [Cloudinary](https://cloudinary.com/) services. For `CLOUDINARY_CLOUD_NAME`, `CLOUDINARY_API_KEY` and `CLOUDINARY_API_SECRET` env vars you will need the values of your Cloudinary "Account Details", to do that you can create your Cloudinary account [here](https://cloudinary.com/users/register/free).

You can setup the environment vars in the host system or use a `.env` file to place them in. If you prefer use this last option,
the file must be in the root of the project.

## Setting up configuration file

Some setting in the server can be changed without touch the source code. This is so to avoid go through the code and getting lost while
looking for the line where the wanted option is. The place to change such options is in `etc/conf.json` and its strcuture is as following.

```json
{
  "path_tracking": {
    "write_to_file": true,
    "write_to_stdout": true
  },
  "session": {
    "expires_in": "7 days"
  },
  "db": {
    "conn_limit": 50
  },
  "moment": {
    "language": "es"
  }
}
```

The shown values is a suggestion.

### Fields descripcion

* `path_tracking.write_to_file`

A boolean indicating if the execution logs of an endpoint must be written in a file.

* `path_tracking.write_to_stdout`

A boolean indicating if the execution logs of an endpoint must be written to the stdout.

* `session.expires_in`

The time limit in which an authorization token is valid. This token is generated using the library `jsonwebtoken`. We use the `sign` method
provided by the library which receive the argument `expiresIn`. Here is where the `session.expires_in` config variable is used.
See [the library doc](https://www.npmjs.com/package/jsonwebtoken) if you want to change the value.

* `db.conn_limit`

We use a service to manage the DB connections. This service contains a pool of MariaDB connections and only allow a certain number of connections.
This number is defined by this config variable.

* `moment.language`

Language that we use to format the date and time in the library Moment.js

## RSA certs

As we said above, we use JWT as user authentication method. The JWTs are generated by using the `RSA SHA256` algorithm which requires the
RSA public and private keys to work. The public key must be in `PEM` format.

The certs must be in the following directory and with the following names.

* `certs/academic_network`
* `certs/academic_network.pem`

If you have a bash-like shell, you can use the following commands to generate the certs.

```sh
ssh-keygen -q -f academic_network -t rsa -m PEM -N ""
ssh-keygen -e -f academic_network -m PEM > academic_network.pem
```

The first command will generate a public/private RSA key pair in the current directory. The second will generate a public key in PEM format
based on the private key.

## SQL scripts

Make sure to run the following sql scripts in the same order before to run the application and start to use the web services. 

1. `src/scripts/db.sql`: This script creates the database and tables to be used.

2. `src/scripts/stored_procedures.sql`: This script creates the stored procedures to be used.

3. `src/scripts/db_initial_setup.sql`: This script will setup the DB with some values to test the current endpoints.
